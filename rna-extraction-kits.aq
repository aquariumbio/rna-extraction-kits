{"config":{"title":"Aquarium RNA Extraction Kits","description":"Modules to provide `show` methods for working with RNA extraction kits","copyright":"University of Washington","version":"0.0.2","authors":[{"name":"Devin Strickland","affilation":"","affiliation":"University of Washington"},{"name":"Dany Fu","affilation":"","affiliation":"Boston University"},{"name":"Rita Chen","affilation":"","affiliation":"Boston University"}],"maintainer":{"name":"Devin Strickland","email":"strcklnd@uw.edu"},"acknowledgements":null,"github":{"user":"dvnstrcklnd","repo":"rna-extraction-kits","organization":"aquariumbio"},"keywords":null,"aquadoc_version":"1.0.2","aquarium_version":"\u003c%= Bioturk::Application.config.aquarium_version %\u003e"},"components":[{"library":{"name":"MagMAXViralIINAIsolationKit","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n# Written By Dany Fu 2020-05-18\n\nneeds 'Standard Libs/LabwareNames'\n\n# MagMAX Viral/Pathogen II Nucleic Acid Isolation Kit\n# 1) Suspend magnetic beads in buffer\n# 2) Proteinase K digestion\n# 3) Wash beads (3x)\n# 4) Release RNA from beads\nmodule MagMAXViralIINAIsolationKit\n  include Units\n  include LabwareNames\n\n  NAME = 'MagMAX Viral/Pathogen II Nucleic Acid Isolation Kit'\n\n  OVERAGE = 1.1 # additional 10%\n  PLATE_SIZE = 96\n  SPEED = 1050 # RPM\n  TEMP = 65 # celcius\n  TIME1 = 1 # 1 min\n  TIME2 = 2 # 2 min\n  TIME3 = 3 # 3 min\n  TIME5 = 5 # 5 min\n  TIME10 = 10 # 10 min\n  VOL_BEADS_PER_WELL = 10.0\n  VOL_BS_PER_WELL = 265.0\n  VOL_CONICAL_TUBE_ML = 15\n  VOL_ELUTION = { qty: 50, units: MICROLITERS }.freeze\n  VOL_ETHANOL = { qty: 250, units: MICROLITERS }.freeze\n  VOL_MS2 = { qty: 5, units: MICROLITERS }.freeze\n  VOL_PROTEINASE_K = { qty: 5, units: MICROLITERS }.freeze\n  VOL_SAMPLE = { qty: 200, units: MICROLITERS }.freeze\n  VOL_WB = { qty: 500, units: MICROLITERS }.freeze # wash buffer\n\n  # 265uL(buffer) + 10uL(beads)=275uL per well\n  # Include 10% overage when making the Binding Bead Mix\n  # for use with multiple reactions\n  def prepare_materials\n    total_beads = ((PLATE_SIZE * VOL_BEADS_PER_WELL * OVERAGE) / 1000).round(2)\n    total_bs = ((PLATE_SIZE * VOL_BS_PER_WELL * OVERAGE) / 1000).round(2)\n    total_vol = total_beads + total_bs\n    num_tubes = { qty: (total_vol / VOL_CONICAL_TUBE_ML).round,\n                  units: TUBE_15_ML_CONICAL }\n    bs_per_tube = { qty: total_bs / num_tubes[:qty], units: MILLILITERS }\n    beads_per_tube = { qty: total_beads / num_tubes[:qty], units: MILLILITERS }\n\n    show do\n      title 'Prepare Binding Bead Mix'\n      check \"Vortex the Total Nucleic Acid Magnetic Beads to ensure \\\n            that the bead mixture is homogeneous\"\n      check \"Add #{qty_display(bs_per_tube)} Binding Solution per tube to \\\n            #{qty_display(num_tubes)}\"\n      check \"Add #{qty_display(beads_per_tube)} Nucleic Acid Magnetic Beads \\\n            per tube to #{qty_display(num_tubes)}\"\n      check 'Mix well by inversion, leave at room temperature'\n    end\n  end\n\n  def notes_on_handling; end\n\n  def lyse_samples_constant_volume(sample_volume:, expert:)\n    make_sample_plate(sample_volume: sample_volume)\n    add_reagents_and_beads\n    shake(time: TIME2, covered: true)\n    incubate(time: TIME5)\n    shake(time: TIME5, covered: true)\n    collect_beads(time: TIME10)\n  end\n\n  def make_sample_plate(sample_volume: nil)\n    sample_volume ||= VOL_SAMPLE\n    operations.each do |op|\n      input_plate = op.input('Specimen')\n      show do\n        title 'Add Samples to New Plate'\n        check \"Make a 96 deepwell plate according to the following table using \\\n              #{qty_display(sample_volume)} of sample\"\n        check \"Add #{qty_display(sample_volume)} of water to the wells marked \\\n              by X as negative controls\"\n        check 'Mark the Negative Control well on the plate'\n\n        title 'New Plate'\n        table input_plate.collection.matrix\n      end\n    end\n  end\n\n  def add_reagents_and_beads\n    show do\n      title 'Add Reagents and Beads'\n      check \"Add #{qty_display(VOL_PROTEINASE_K)} of Proteinase K to each \\\n            well of deepwell 96 Plate\"\n      check \"Invert the Binding Bead Mix 5 times gently to mix, then add \\\n            #{qty_display(VOL_PROTEINASE_K)} to each sample well and \\\n            Negative Control well\"\n      warning \"Remix the Binding Bead Mix by inversion frequently during \\\n              pipetting to ensure even distribution of beads to all wells.\"\n      warning \"The Binding Bead Mix is viscous, so pipet slowly to ensure \\\n              that the correct amount is added\"\n      check \"Add #{qty_display(VOL_MS2)} of MS2 Phage Control to each sample \\\n            well and to the Negative Control well.\"\n      check 'Seal the plate with clear adhesive film'\n    end\n  end\n\n  def shake(time:, covered:)\n    cover = covered ? 'covered' : 'uncovered'\n    show do\n      title 'Shake Plate'\n      check \"Shake the \u003cb\u003e#{cover}\u003c/b\u003e plate at #{SPEED} RPM for \\\n            #{time} #{MINUTES}\"\n      timer initial: { minutes: time }\n    end\n  end\n\n  def incubate(time:)\n    show do\n      title 'Incubate Sealed Plate'\n      note 'Ensure the bottom of the plate is uncovered'\n      check \"Incubate plate at #{TEMP} #{DEGREES_C}for #{time} #{MINUTES}\"\n      timer initial: { minutes: time }\n    end\n  end\n\n  def collect_beads(time:)\n    show do\n      title 'Collect Beads on Magnetic Stand'\n      check \"Place the sealed plate on the magnetic stand for \\\n            #{time} #{MINUTES} or until all of the beads have collected\"\n    end\n  end\n\n  def bind_rna(operations:, sample_volume:, expert:); end\n\n  def wash_rna(operations:, expert:)\n    wash_beads(reagent: 'Wash Buffer', vol: VOL_WB[:qty])\n    wash_beads(reagent: '80% Ethanol', vol: VOL_WB[:qty]) # same as wash buffer\n    wash_beads(reagent: '80% Ethanol', vol: VOL_ETHANOL[:qty])\n    shake(time: TIME2, covered: false) # dry beads\n  end\n\n  def wash_beads(reagent:, vol:)\n    discard_supernant if reagent == 'Wash Buffer'\n    wash(reagent: reagent, vol: vol)\n    shake(time: TIME1, covered: true)\n    collect_beads(time: TIME2)\n    discard_supernant\n  end\n\n  def discard_supernant\n    show do\n      title 'Discard supernant'\n      warning 'IMPORTANT! Avoid disturbing the beads'\n      check \"Keeping the plate on the magnet, carefully remove the cover, \\\n            then discard the supernatant from each well\"\n    end\n  end\n\n  def wash(reagent:, vol:)\n    show do\n      title 'Wash Beads'\n      check \"Remove the plate from the magnetic stand, then add \\\n            #{vol} #{MICROLITERS} of #{reagent} to each sample\"\n    end\n  end\n\n  def elute_rna(operations:, expert:)\n    add_elution_solution\n    shake(time: TIME5, covered: true)\n    incubate(time: TIME10)\n    shake(time: TIME5, covered: true)\n    collect_beads(time: TIME3)\n    make_qpcr_plate(ops: operations)\n  end\n\n  def add_elution_solution\n    show do\n      title 'Add Elution Solution'\n      check \"Remove the plate from the magnetic stand, then add \\\n            #{qty_display(VOL_ELUTION)} of Elution Solution to each sample\"\n      check 'Seal the plate with Clear Adhesive Film'\n    end\n  end\n\n  def make_qpcr_plate(ops:)\n    ops.make\n    ops.each do |op|\n      input_collection = op.input('Specimen').collection\n      input_collection.mark_as_deleted\n      output_collection = op.output('Specimen').collection\n      output_collection.associate_matrix(input_collection.matrix)\n    end\n    show do\n      title 'Make qPCR Plate'\n      warning \"Pay special attention to transfer liquid solution only. \\\n              Significant bead carry over may adversely impact qPCR performance\"\n      check 'Keeping the plate on the magnet, carefully remove the seal'\n      check 'Transfer the eluates to a 96 well qPCR plate'\n      check 'Mark the Negative Control well on the plate'\n      check 'Seal the new plate with Clear Adhesive Film'\n      check 'Place the plate on ice for immediate use in qPCR'\n    end\n  end\nend\n"}},{"library":{"name":"QIAampDSPViralRNAMiniKit","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'RNA Extraction Kits/QiagenRNAExtractionHelper'\n\n# Module for QIAamp DSP Viral RNA Mini Kit\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule QIAampDSPViralRNAMiniKit\n  include QiagenRNAExtractionHelper\n\n  NAME = 'QIAamp DSP Viral RNA Mini Kit'\n\n  COLUMN_LONG = 'QIAamp Mini spin column'\n\n  MIN_SAMPLE_VOLUME =     { qty: 140, units: MICROLITERS }.freeze\n  DEFAULT_SAMPLE_VOLUME = MIN_SAMPLE_VOLUME\n  WASH_VOLUME =           { qty: 500, units: MICROLITERS }.freeze\n\n  CENTRIFUGE_SPEED = { qty: 6000, units: TIMES_G }.freeze\n  CENTRIFUGE_TIME = { qty: 1, units: MINUTES }.freeze\n\n  def prepare_materials\n    show do\n      title 'Things to do before starting'\n      bullet \"Equilibrate samples to room temperature (15-25#{DEGREES_C})\"\n      bullet 'Equilibrate Buffer AVE to room temperature'\n      # TODO: Need some way of indicating this has been done\n      bullet 'Check that Buffer AW1 and Buffer AW2 have been prepared ' \\\n        'according to the instructions'\n      # TODO: Need some way of indicating this has been done\n      bullet 'Add carrier RNA reconstituted in Buffer AVE to Buffer AVL ' \\\n        'according to the instructions'\n    end\n  end\n\n  def notes_on_handling\n    qiagen_notes_on_handling\n  end\n\n  # @todo will we be working with a different sample volume for each operation?\n  # @todo make use_operations do this^\n  def lyse_samples_constant_volume(sample_volume: DEFAULT_SAMPLE_VOLUME,\n                                   expert: false)\n    # TODO: Move this logic up to the calling method\n    if sample_volume[:qty] \u003c MIN_SAMPLE_VOLUME[:qty]\n      msg = \"Sample volume must be \u003e #{qty_display(MIN_SAMPLE_VOLUME)}\"\n      raise ProtocolError, msg\n    end\n    buffer_volume = lysis_buffer_volume(sample_volume: sample_volume)\n    ethanol_volume = ethanol_volume(sample_volume: sample_volume)\n\n    show do\n      title 'Lyse Samples'\n\n      # TODO: Add Pipettor module\n      note \"Pipet #{qty_display(buffer_volume)} of prepared Buffer AVL \" \\\n        'containing carrier RNA into a lysis tube (LT).'\n      # If the sample volume is larger than 140 ul, increase the amount of\n      # Buffer AVL-carrier RNA proportionally (e.g., a 280 ul sample will\n      # require 1120 ul Buffer AVL-carrier RNA) and use a larger tube.\n      note \"Add #{qty_display(sample_volume)} plasma, serum, urine, \" \\\n        'cell-culture supernatant, or cell- free body fluid to the ' \\\n        'Buffer AVL-carrier RNA in the lysis tube (LT).'\n      note \"Mix by pulse-vortexing for 15 #{SECONDS}.\"\n      warning 'To ensure efficient lysis, it is essential that the sample ' \\\n        'is mixed thoroughly with Buffer AVL to yield a homogeneous solution'\n      # Frozen samples that have only been thawed once can also be used.\n      note \"Incubate at room temperature (15-25#{DEGREES_C}) for 10 #{MINUTES}\"\n    end\n\n    show do\n      title 'Add Ethanol'\n\n      note 'Briefly centrifuge the lysis tube (LT) to remove drops from ' \\\n        'the inside of the lid.'\n      note \"Add #{qty_display(ethanol_volume)} ethanol (96-100%) to the \" \\\n        'sample, and mix by pulse-vortexing for \u003e15 seconds. ' \\\n        'After mixing, briefly centrifuge the tube to remove drops from ' \\\n        'inside the lid.'\n      # Only ethanol should be used since other alcohols may result in\n      # reduced RNA yield and purity. Do not use denatured alcohol, which\n      # contains other substances such as methanol or methylethylketone.\n      # If the sample volume is greater than 140 ul, increase the amount of\n      # ethanol proportionally (e.g., a 280 ul sample will require\n      # 1120 ul of ethanol). In order to ensure efficient binding, it is\n      # essential that the sample is mixed thoroughly with the ethanol\n      # to yield a homogeneous solution.\n    end\n  end\n\n  def lyse_samples_variable_volume(operations:, expert: false)\n    msg = 'Method lyse_samples_variable_volume is not supported for ' \\\n      'QIAamp DSP Viral RNA Mini Kit'\n    raise ProtocolError, msg\n  end\n\n  def bind_rna(operations: [], sample_volume: DEFAULT_SAMPLE_VOLUME,\n               expert: false)\n    loading_volume, n_loads = loading_volume(sample_volume: sample_volume)\n\n    show do\n      title 'Add Samples to Columns'\n\n      note \"Carefully apply #{qty_display(loading_volume)} of the \" \\\n        \"sample solution to the #{COLUMN_LONG} (in a #{WASH_TUBE_LONG}) \" \\\n        'without wetting the rim.'\n      note \"Close the cap, and centrifuge at #{CENTRIFUGE_SPEED} \" \\\n        \"for #{CENTRIFUGE_TIME}. Place the #{COLUMN_SHORT} into a clean\" \\\n        \"#{WASH_TUBE_SHORT}, and discard the old #{WASH_TUBE_SHORT} \" \\\n        'containing the filtrate.'\n      warning 'Close each spin column in order to avoid cross-contamination ' \\\n        'during centrifugation.'\n      # Centrifugation is performed at approximately 6000 x g in order to limit\n      # microcentrifuge noise. Centrifugation at full speed will not affect the\n      # yield or purity of the viral RNA. If the solution has not completely\n      # passed through the membrane, centrifuge again at a higher speed\n      # until all of the solution has passed through.\n      separator\n\n      # Harmonize handling of repeats with RNeasy kit\n      note \"Carefully open the #{COLUMN_SHORT}, and repeat the loading until \" \\\n        'all of the lysate has been loaded onto the spin column.'\n    end\n  end\n\n  def wash_rna(operations: [], expert: false)\n    show do\n      title 'Wash with Buffer AW1'\n\n      note \"Carefully open the #{COLUMN_LONG}, and add \" \\\n        \"#{qty_display(WASH_VOLUME)} Buffer AW1.\"\n      note 'Close the cap, and centrifuge at ' \\\n        \"#{CENTRIFUGE_SPEED} for #{CENTRIFUGE_TIME}.\"\n      note \"Place the #{COLUMN_SHORT} in a clean #{WASH_TUBE_LONG}, \" \\\n        \"and discard the #{WASH_TUBE_SHORT} containing the filtrate.\"\n      # It is not necessary to increase the volume of Buffer AW1 even if the\n      # original sample volume was larger than 140 ul.\n    end\n\n    show do\n      title 'Wash with Buffer AW2'\n\n      note \"Carefully open the #{COLUMN_LONG}, and add \" \\\n        \"#{qty_display(WASH_VOLUME)} Buffer AW2.\"\n      # This centrifuge speed is meant to be different\n      note 'Close the cap and centrifuge at full speed ' \\\n        \"(approximately 20,000 #{TIMES_G}) for 3 #{MINUTES}.\"\n      separator\n\n      note \"Place the #{COLUMN_SHORT} in a new #{WASH_TUBE_LONG}, \" \\\n        \"and discard the #{WASH_TUBE_SHORT} containing the filtrate.\"\n      # This centrifuge speed is meant to be different\n      note \"Centrifuge at full speed for 1 #{MINUTES}.\"\n    end\n  end\n\n  def elute_rna(operations: [], expert: false)\n    show do\n      title 'Elute RNA'\n\n      note \"Place the #{COLUMN_LONG} in a clean #{ELUTION_TUBE_LONG}.\"\n      note 'Discard the wash tube containing the filtrate.'\n      note \"Carefully open the #{COLUMN_SHORT} and add \" \\\n        \"60 #{MICROLITERS} of Buffer AVE equilibrated to room temperature.\"\n      note \"Close the cap, and incubate at room temperature for \u003e1 #{MINUTES}.\"\n      note \"Centrifuge at #{CENTRIFUGE_SPEED} \" \\\n        \"for #{CENTRIFUGE_TIME}.\"\n    end\n  end\n\n  private\n\n  def lysis_buffer_volume(sample_volume:)\n    unless sample_volume[:units] == MICROLITERS\n      raise ProtocolError, \"Parameter :sample_volume must be in #{MICROLITERS}\"\n    end\n\n    qty = sample_volume[:qty] * 560 / 140\n    { qty: qty, units: MICROLITERS }\n  end\n\n  def ethanol_volume(sample_volume:)\n    qty = lysis_buffer_volume(sample_volume: sample_volume)\n    { qty: qty, units: MICROLITERS }\n  end\n\n  # TODO: Is this right?\n  def loading_volume(sample_volume:)\n    qty = 630\n    n_loads = 2\n    [{ qty: qty, units: MICROLITERS }, n_loads]\n  end\nend\n"}},{"library":{"name":"QiagenRNAExtractionHelper","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'Standard Libs/Units'\n\n# Module for common methods and constants in Qiagen RNA extraction kits\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule QiagenRNAExtractionHelper\n  include Units\n\n  COLUMN_LONG = 'Qiagen spin column'\n  COLUMN_SHORT = 'spin column'\n\n  LYSIS_TUBE_LONG = 'lysis tube (LT)'\n  LYSIS_TUBE_SHORT = 'LT'\n\n  WASH_TUBE_LONG = \"2 #{MILLILITERS} wash tube (WT)\"\n  WASH_TUBE_SHORT = 'WT'\n\n  ELUTION_TUBE_LONG = 'elution tube (ET)'\n  ELUTION_TUBE_SHORT = 'ET'\n\n  # @note adapted from QIAamp DSP Viral RNA Mini Kit\n  # @todo determine how much of the detail to keep or change\n  def qiagen_notes_on_handling\n    show do\n      title \"Handling of #{COLUMN_LONG.pluralize}\"\n\n      note 'Due to the sensitivity of nucleic acid amplification ' \\\n        'technologies, the following precautions are necessary when handling ' \\\n        \"#{COLUMN_LONG.pluralize} to avoid cross contamination between \" \\\n        'sample preparations:'\n      bullet \"Carefully apply the sample or solution to the #{COLUMN_SHORT}. \" \\\n        \"Pipet the sample into the #{COLUMN_SHORT} \" \\\n        'without wetting the rim of the column.'\n      bullet 'Always change pipet tips between liquid transfers. ' \\\n        'We recommend the use of aerosol-barrier pipet tips.'\n      bullet \"Avoid touching the #{COLUMN_SHORT} membrane with \" \\\n        'the pipet tip.'\n      bullet 'After all pulse-vortexing steps, briefly centrifuge the ' \\\n       'microcentrifuge tubes to remove drops from the inside of the lids.'\n      bullet \"Open only one #{COLUMN_SHORT} at a time, and take care \" \\\n        'to avoid generating aerosols.'\n      bullet 'Wear gloves throughout the entire procedure. In case of ' \\\n        'contact between gloves and sample, change gloves immediately.'\n    end\n  end\nend\n"}},{"library":{"name":"QiagenRNeasyMiniKit","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'RNA Extraction Kits/QiagenRNAExtractionHelper'\n\n# Module for Qiagen RNeasy Mini Kit\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\n# @note The instructions here are based on the BU Center for Regenerative\n#   Medicine COVID-19 test (http://www.bu.edu/dbin/stemcells/covid-19.php)\nmodule QiagenRNeasyMiniKit\n  include QiagenRNAExtractionHelper\n\n  NAME = 'Qiagen RNeasy Mini Kit'\n\n  COLUMN_LONG = 'RNeasy spin column'\n\n  MIN_SAMPLE_VOLUME = { qty: 300, units: MICROLITERS }.freeze\n  DEFAULT_SAMPLE_VOLUME = MIN_SAMPLE_VOLUME\n\n  CENTRIFUGE_SPEED = { qty: 8000, units: TIMES_G }.freeze\n  CENTRIFUGE_TIME = { qty: 15, units: SECONDS }.freeze\n  CENTRIFUGE_TIME_AND_SPEED = \"#{Units.qty_display(CENTRIFUGE_TIME)} at \" \\\n    \"#{Units.qty_display(CENTRIFUGE_SPEED)}\"\n\n  LYSIS_BUFFER = 'Buffer RLT'\n\n  ELUTION_VOLUME = { qty: 50, units: MICROLITERS }.freeze\n  ELUTION_TUBE_LONG = \"new 1.5 #{MILLILITERS} collection tube (supplied)\"\n  ELUTION_TUBE_SHORT = 'collection tube'\n\n  # @todo may need to add something from the Qiagen manual\n  def prepare_materials; end\n\n  def notes_on_handling\n    qiagen_notes_on_handling\n  end\n\n  # @note adapted from `QIAampDSPViralRNAMiniKit`\n  # @todo determine how much of the detail to keep or change\n  def lyse_samples_constant_volume(sample_volume: DEFAULT_SAMPLE_VOLUME,\n                                   expert: false)\n    # TODO: Move this logic up to the calling method\n    if sample_volume[:qty] \u003c MIN_SAMPLE_VOLUME[:qty]\n      msg = \"Sample volume must be \u003e #{qty_display(MIN_SAMPLE_VOLUME)}\"\n      raise ProtocolError, msg\n    end\n    buffer_volume = lysis_buffer_volume(sample_volume: sample_volume)\n    ethanol_volume = ethanol_volume(sample_volume: sample_volume)\n\n    show do\n      title 'Lyse Samples'\n\n      note \"Pipet #{qty_display(buffer_volume)} of #{LYSIS_BUFFER} \" \\\n        \"into a #{LYSIS_TUBE_LONG}.\"\n      note \"Add #{qty_display(sample_volume)} sample to the \" \\\n        \"#{LYSIS_BUFFER} in the #{LYSIS_TUBE_SHORT}.\"\n      # TODO: Should this be kept in?\n      # note \"Mix by pulse-vortexing for 15 #{SECONDS}.\"\n      warning 'To ensure efficient lysis, it is essential that the sample is ' \\\n        \"mixed thoroughly with #{LYSIS_BUFFER} to yield a homogeneous solution\"\n      # Frozen samples that have only been thawed once can also be used.\n      # TODO: Should this be kept in?\n      # note \"Incubate at room temperature (15-25#{DEGREES_C}) for 10 #{MINUTES}\"\n    end\n\n    show do\n      title 'Add Ethanol'\n\n      note \"Briefly centrifuge the #{LYSIS_TUBE_LONG} to remove drops from \" \\\n        'the inside of the lid.'\n      note \"Add #{qty_display(ethanol_volume)} ethanol (100%) to the \" \\\n        'sample, and mix by pulse-vortexing for \u003e15 seconds. ' \\\n        'After mixing, briefly centrifuge the tube to remove drops from ' \\\n        'inside the lid.'\n      # Only ethanol should be used since other alcohols may result in\n      # reduced RNA yield and purity. Do not use denatured alcohol, which\n      # contains other substances such as methanol or methylethylketone.\n      # If the sample volume is greater than 140 ul, increase the amount of\n      # ethanol proportionally (e.g., a 280 ul sample will require\n      # 1120 ul of ethanol). In order to ensure efficient binding, it is\n      # essential that the sample is mixed thoroughly with the ethanol\n      # to yield a homogeneous solution.\n    end\n  end\n\n  def lyse_samples_variable_volume(operations:, expert: false)\n    msg = 'Method lyse_samples_variable_volume is not supported for ' \\\n      'Qiagen RNeasy Mini Kit'\n    raise ProtocolError, msg\n  end\n\n  # @note adapted from `QIAampDSPViralRNAMiniKit`\n  # @todo determine how much of the detail to keep or change\n  def bind_rna(operations: [], sample_volume: DEFAULT_SAMPLE_VOLUME,\n               expert: false)\n    loading_volume, n_loads = loading_volume(sample_volume: sample_volume)\n\n    show do\n      title 'Add Samples to Columns'\n\n      note \"Carefully apply #{qty_display(loading_volume)} of the sample \" \\\n        \"solution to the #{COLUMN_LONG} (in a wash tube (WT)) without \" \\\n        'wetting the rim.'\n      note \"Close the cap, and centrifuge for #{CENTRIFUGE_TIME_AND_SPEED}.\"\n      note \"Place the #{COLUMN_SHORT} into a clean #{WASH_TUBE_LONG}, and \" \\\n        'discard the wash tube containing the filtrate.'\n      warning 'Close each spin column in order to avoid cross-contamination ' \\\n        'during centrifugation.'\n      # Centrifugation is performed at approximately 6000 x g in order to limit\n      # microcentrifuge noise. Centrifugation at full speed will not affect the\n      # yield or purity of the viral RNA. If the solution has not completely\n      # passed through the membrane, centrifuge again at a higher speed\n      # until all of the solution has passed through.\n      separator\n\n      note \"Carefully open the #{COLUMN_SHORT}, and repeat the \" \\\n        \"loading #{n_loads - 1} more times until all of the lysate has \" \\\n        'been loaded onto the spin column.'\n    end\n  end\n\n  def wash_rna(operations: [], expert: false)\n    show do\n      title 'Wash with Buffer RW1'\n\n      note \"Add 700 #{MICROLITERS} Buffer RW1 to the #{COLUMN_LONG}.\"\n      note 'Close the lid gently, and centrifuge for ' \\\n        \"#{CENTRIFUGE_TIME_AND_SPEED}.\"\n      warning \"Carefully remove the #{COLUMN_SHORT} from the collection \" \\\n        'tube so that the column does not contact the flow-through.'\n      note 'Empty the collection tube completely.'\n      note 'Reuse the collection tube in the next step.'\n    end\n\n    show do\n      title 'Wash twice with Buffer RPE'\n\n      note \"Add 500 #{MICROLITERS} Buffer RPE to the #{COLUMN_LONG}.\"\n      note 'Close the lid gently, and centrifuge for ' \\\n        \"#{CENTRIFUGE_TIME_AND_SPEED}.\"\n      note 'Empty the collection tube.'\n      note 'Reuse the collection tube in the next step.'\n      # Note: Buffer RPE is supplied as a concentrate. Ensure that ethanol is\n      # added to Buffer RPE before use (see Things to do before starting).\n      separator\n\n      note \"Add 500 #{MICROLITERS} Buffer RPE to the #{COLUMN_SHORT}.\"\n      # The long centrifugation dries the spin column membrane, ensuring that\n      # no ethanol is carried over during RNA elution. Residual ethanol may\n      # interfere with downstream reactions.\n      note \"Close the lid gently, and centrifuge for 2 #{MINUTES} at \" \\\n        \"#{qty_display(CENTRIFUGE_SPEED)}.\"\n      warning \"Carefully remove the #{COLUMN_SHORT} from the collection \" \\\n        'tube so that the column does not contact the flow-through.'\n      note 'Discard the collection tube.'\n      separator\n\n      # TODO: Should we do this step?\n      note \"Place the #{COLUMN_SHORT} in a new #{WASH_TUBE_LONG}, \" \\\n        \"and discard the #{WASH_TUBE_SHORT} containing the filtrate.\"\n      # This centrifuge speed is meant to be different\n      note \"Centrifuge at full speed for 1 #{MINUTES}.\"\n    end\n  end\n\n  def elute_rna(operations: [], expert: false)\n    show do\n      title 'Elute RNA'\n\n      note \"Place the #{COLUMN_LONG} in a #{ELUTION_TUBE_LONG}.\"\n      note \"Add #{qty_display(ELUTION_VOLUME)} RNAse-free water directly \" \\\n        'to the spin column membrane.'\n      note \"Close the lid gently, and centrifuge for 1 #{MINUTES} at \" \\\n        \"#{qty_display(CENTRIFUGE_SPEED)}.\"\n    end\n  end\n\n  private\n\n  # @todo generalize this for all sample lysis buffers\n  def lysis_buffer_volume(sample_volume:)\n    unless sample_volume[:units] == MICROLITERS\n      raise ProtocolError, \"Parameter :sample_volume must be in #{MICROLITERS}\"\n    end\n\n    qty = sample_volume[:qty]\n    { qty: qty, units: MICROLITERS }\n  end\n\n  def ethanol_volume(sample_volume:)\n    qty = sample_volume[:qty] * 2.0\n    { qty: qty, units: MICROLITERS }\n  end\n\n  def loading_volume(sample_volume:)\n    qty = sample_volume[:qty]\n    qty += lysis_buffer_volume(sample_volume: sample_volume)[:qty]\n    qty += ethanol_volume(sample_volume: sample_volume)[:qty]\n    if qty \u003c= 600\n      n_loads = 1\n    elsif qty \u003c= 1200\n      n_loads = 2\n    elsif qty \u003c= 1800\n      n_loads = 3\n    else\n      raise ProtocolError, 'Parameter :sample_volume must be \u003c= 1800 ' \\\n        \"#{MICROLITERS}\"\n    end\n    qty /= n_loads.to_f\n    [{ qty: qty, units: MICROLITERS }, n_loads]\n  end\nend\n"}},{"library":{"name":"RNAExtractionHelper","category":"RNA Extraction Kits","code_source":"# typed: false\n# frozen_string_literal: true\n\nneeds 'Standard Libs/PlanParams'\nneeds 'Standard Libs/Units'\nneeds 'Standard Libs/Debug'\nneeds 'RNA Extraction Kits/RNAExtractionKits'\n\n# Module for elements that are common to RNA Extraction Protocols\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule RNAExtractionHelper\n  include PlanParams\n  include Units\n  include Debug\n  include RNAExtractionKits\n\n  def sample_volume(operation)\n    operation.temporary[:options][:sample_volume]\n  end\nend\n"}},{"library":{"name":"RNAExtractionKits","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'RNA Extraction Kits/SupportedRNAExtractionKits'\n\n# Module for switching among several different RNA extraction kits\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule RNAExtractionKits\n  include SupportedRNAExtractionKits\n\n  # Run the protocol defined by the kit\n  #\n  # @note if `sample_volume` is provided, then all samples will be run\n  #   using that volume of sample\n  # @note if `sample_volume` is not provided, but `operations` are, then\n  #   the protocol will look for sample_volumes assigned to the `Operations`\n  # @note if neither `sample_volume` nor `operations` are provided, then\n  #   all samples will be run using `DEFAULT_SAMPLE_VOLUME`\n  # @param operations [OperationList] the operations to run\n  # @param sample_volume [Hash] the volume as a Hash in the format\n  #   `{ qty: 140, units: MICROLITERS }`\n  # @return [void]\n  def run_rna_extraction_kit(operations: [], sample_volume: nil, expert: false)\n    prepare_materials\n\n    notes_on_handling unless expert\n\n    if sample_volume\n      lyse_samples_constant_volume(sample_volume: sample_volume, expert: expert)\n    elsif operations.present?\n      lyse_samples_variable_volume(operations: operations, expert: expert)\n    else\n      lyse_samples_constant_volume(expert: expert)\n    end\n\n    bind_rna(\n      operations: operations,\n      sample_volume: sample_volume,\n      expert: expert\n    )\n\n    wash_rna(operations: operations, expert: expert)\n\n    elute_rna(operations: operations, expert: expert)\n  end\nend\n"}},{"library":{"name":"SupportedRNAExtractionKits","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'RNA Extraction Kits/TestRNAExtractionKit'\nneeds 'RNA Extraction Kits/QIAampDSPViralRNAMiniKit'\nneeds 'RNA Extraction Kits/QiagenRNeasyMiniKit'\n\n# Module for enumerating supported RNA extraction kits\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule SupportedRNAExtractionKits\n  # Extend the module with the correct methods based on the kit name\n  #\n  # @param name [String] the name of the kit\n  # @return [void]\n  def set_kit(name:)\n    case name\n    when TestRNAExtractionKit::NAME\n      extend TestRNAExtractionKit\n    when QIAampDSPViralRNAMiniKit::NAME\n      extend QIAampDSPViralRNAMiniKit\n    when QiagenRNeasyMiniKit::NAME\n      extend QiagenRNeasyMiniKit\n    else\n      raise ProtocolError, \"Unrecognized RNA Extraction Kit: #{name}\"\n    end\n  end\nend\n"}},{"library":{"name":"TestRNAExtractionKit","category":"RNA Extraction Kits","code_source":"# frozen_string_literal: true\n\nneeds 'Standard Libs/Units'\n\n# Minimal RNA Extraction Kit Module for testing\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nmodule TestRNAExtractionKit\n  include Units\n\n  NAME = 'Test RNA Extraction Kit'\n\n  MIN_SAMPLE_VOLUME =     { qty: 140, units: MICROLITERS }.freeze\n  DEFAULT_SAMPLE_VOLUME = MIN_SAMPLE_VOLUME\n\n  def prepare_materials\n    show do\n      title 'Things to do before starting'\n    end\n  end\n\n  def notes_on_handling\n    show do\n      title 'Handling Materials'\n    end\n  end\n\n  def lyse_samples_constant_volume(sample_volume:, expert: false)\n    show do\n      title 'Lyse Samples Constant Volume'\n\n      note \"Sample volume: #{qty_display(sample_volume)}\"\n    end\n  end\n\n  def lyse_samples_variable_volume(operations:, expert: false)\n    show do\n      title 'Lyse Samples Variable Volume'\n\n      operations.each { |op| note \"Sample volume: #{sample_volume(op)}\" }\n    end\n  end\n\n  def bind_rna(operations: [], sample_volume: DEFAULT_SAMPLE_VOLUME,\n               expert: false)\n    show do\n      title 'Add Samples to Columns'\n    end\n  end\n\n  def wash_rna(operations: [], expert: false)\n    show do\n      title 'Wash with Buffer'\n    end\n  end\n\n  def elute_rna(operations: [], expert: false)\n    show do\n      title 'Elute RNA'\n    end\n  end\nend\n"}},{"sample_types":[],"object_types":[],"operation_type":{"name":"RNA Extraction Test","category":"Test","deployed":false,"on_the_fly":false,"field_types":[{"ftype":"json","role":"input","name":"Options","sample_types":[],"object_types":[],"part":false,"array":false,"routing":null,"preferred_operation_type_id":null,"preferred_field_type_id":null,"choices":null}],"protocol":"# frozen_string_literal: true\n\nneeds 'Standard Libs/PlanParams'\nneeds 'Standard Libs/Units'\nneeds 'Standard Libs/Debug'\nneeds 'RNA Extraction Kits/RNAExtractionKits'\n\n# Test Extract RNA Protocol\n#\n# @author Devin Strickland \u003cstrcklnd@uw.edu\u003e\nclass Protocol\n  include PlanParams\n  include Units\n  include Debug\n  include RNAExtractionKits\n\n  ########## DEFAULT PARAMS ##########\n\n  # Default parameters that are applied equally to all operations.\n  #   Can be overridden by:\n  #   * Associating a JSON-formatted list of key, value pairs to the `Plan`.\n  #   * Adding a JSON-formatted list of key, value pairs to an `Operation`\n  #     input of type JSON and named `Options`.\n  #\n  def default_job_params\n    {\n      rna_extraction_kit: TestRNAExtractionKit::NAME,\n      expert: false\n    }\n  end\n\n  # Default parameters that are applied to individual operations.\n  #   Can be overridden by:\n  #   * Adding a JSON-formatted list of key, value pairs to an `Operation`\n  #     input of type JSON and named `Options`.\n  #\n  def default_operation_params\n    {\n      sample_volume: { qty: 300, units: MICROLITERS }\n\n    }\n  end\n\n  ########## MAIN ##########\n\n  def main\n    setup_test_options(operations: operations) if debug\n\n    @job_params = update_all_params(\n      operations: operations,\n      default_job_params: default_job_params,\n      default_operation_params: default_operation_params\n    )\n    return {} if operations.errored.any?\n\n    operations.retrieve.make\n\n    set_kit(name: @job_params[:rna_extraction_kit])\n\n    sample_volumes = operation_sample_volumes(operations)\n    if sample_volumes.uniq.length == 1\n      run_rna_extraction_kit(\n        sample_volume: sample_volumes.first,\n        expert: @job_params[:expert]\n      )\n    else\n      run_rna_extraction_kit(\n        operations: operations,\n        expert: @job_params[:expert]\n      )\n    end\n\n    operations.store\n\n    {}\n  end\n\n  def operation_sample_volumes(operations)\n    operations.map { |op| op.temporary[:options][:sample_volume] }\n  end\nend\n","precondition":"def precondition(_op)\n  true\nend","cost_model":"def cost(_op)\n  { labor: 0, materials: 0 }\nend","documentation":"Documentation here. Start with a paragraph, not a heading or title, as in most views, the title will be supplied by the view.","test":"# frozen_string_literal: true\n\nclass ProtocolTest \u003c ProtocolTestBase\n  def setup\n    # add_random_operations(1)\n\n    # Use this if you want to test alternative extraction kits\n    # Kits\n    #   Qiagen RNeasy Mini Kit\n    #   QIAamp DSP Viral RNA Mini Kit\n    #   Test RNA Extraction Kit\n    #   MagMAX Viral/Pathogen II Nucleic Acid Isolation Kit\n    add_operation\n      .with_property(\n        'Options',\n        '{ \"rna_extraction_kit\": \"MagMAX Viral/Pathogen II Nucleic Acid Isolation Kit\", \"expert\": false }'\n      )\n  end\n\n  def analyze\n    log('Hello from Nemo')\n    assert_equal(@backtrace.last[:operation], 'complete')\n  end\nend\n","timing":null}}]}
